---
title:  "Capital and Flights (Group F)"
subtitle: "A Final Report Prepared For S225"
author: "Jocelyn, Daniel"
date: "4/28/2018"
header-includes:
    - \usepackage{setspace}\doublespacing
output: 
  pdf_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE, message=F,warning=F}
library(tidyverse)
# require(mosaic)
# require(NSM3)
# require(Rfit)
# require(dunn.test)
library(reshape2)
# set.seed(4)
groupfdata <- read.csv("Data/final_data.csv") %>% .[2:ncol(.)]
library(png)
library(grid)
```


## Abstract
Travel, particularly via plane, is dependent upon the capital available to an individual. We seek to investigate whether or not there is a relationship between a country's change in wealth and development status classification with the number of flights originating in a given country. Simple parametric and non-parametric regression indicate that average Per Capita GDP Growth is a significant predictor of the normalized, natural log of the number of originating flights, but the model itself fails to adequately explain the variation in flights. Results associated with the ANOVA and Kurskal Wallis Test provide strong evidence for a difference in the mean and median natural log of flights, respectively, between countries of different developmental status. Further analysis using two-sample proportion tests and binomial tests indicates that travel preferences may exist between developing and developed countries. 


## Introduction

The focus of this project will be on exploring differences in travel, via plane, between countries stratified by  development status. One measure to distinguish between developed and developing nations is gross domestic product (GDP) on a per capita basis, i.e. adjusted by the country's  population. Additionally, GDP per capita is often adjusted  for the different living costs between countries by applying a purchasing power parity adjustment (PPP). In this  project we use GDP per capita (PPP) figures made available  from the  World Bank. [2]

A GDP per capita (PPP) of greater than $12,000 is often considered the unofficial benchmark of a developed nation. [3] As 2010 was the year for which we had the  most GDP data, we classified our countries as developing if their GDP per capita (PPP) was greater than \$10490.48 (inflation-adjusted from today) in 2010. Countries with GDP figures less than this cutoff were classified  as  developing  countries, and countries that  were developing in 2010 but developed in  2016 — the last year for  which we have GDP figures — were classified as recently developed.

In this project, we hope to answer the following questions in order o better understand any underlying travel trends between developed and developing countries:  

1. Can we predict the number of flights using average GDP growth? 
2. Is there a difference in the number of flights between developed and developing countries? Recently developed countries? 
3. Do developing countries fly to the same destinations as developed countries do?

In our analysis, we utilized simple linear regression to model the relationship between the number of flights per country and the associated average Per Capita GDP growth. After transforming the data to alleviate concerns with the conditions, we found that there was a significant relationship between the transformed variable of flights and average Per Capita GDP growth. However, we question the model's viability as a useful predictive model.

Two statistical procedures for measuring the differences in center were used to determine if there was a significant difference in flights between countires of different developmental status. Both procedures indicated that there is a signficant difference between the means and medians of flights. Additionally, results of our two sample proportion tests and binomial tests suggest differences some significant differences in travel locations.

Given that airplane tickets are rarely cheap and often unaffordable for many people, it appears safe to assume that developed countries should have a greater demand for airplane travel than developing countries. By answering our questions we may be able to understand how different travel is for people in developing and developed nations. It may also provide the groundwork for additional questions related to travel.

## Data

The final, working dataset for this project is composed of three separate datasets, merged based on the flight source and destination country. The first set includes data on 59,036 flights since 2012. This data was obtained from the Flight Route Database [1]. For each flight, information on the origin, destination, and various characteristics of the flight are included. 

The second set includes data on the Per Capita GDP (ppp) for each country from 1960 to 2016. This dataset was obtained from ‘The World Bank’ website [2]. For our purposes, the dataset was filtered for GDP entries from 2010 to 2016. 

The third, and final, set includes data on the current  (2018) estimated population of each country. This simple data set, obtained from ‘The World Population Review’ website, simply contains the country name, its population, and its population rank. Per Capita GDP data was combined with the flight data by matching the country code. Population data was then matched via the source country name and the destination country name to create two population measures per flight.

Our final, combined dataset, includes 33,559 rows, each corresponding to a flight, with the following selected variables of interest:

- **Destination Country** - the name of the country to which the plane flew.
- **Destination Country Code** - the code of the country to which the plane flew.
- **Source Country** - the name of the country from where the plane flew.
- **Source Country Code** - the code of the country from which the plane flew.
- **Developed.X** - whether or not the source country is developed or developing.
- **Developed.Y** - whether or not the destination country is developed or developing.
- **Average Growth.X** - the average Per Capita GDP growth of the source country between 2010 and 2016 measured in USD.
- **Average Growth.Y** - the average Per Capita GDP growth of the destination country between 2010 and 2016 measured in USD.
- **Population.X** - the estimated population of the source country in 2018.
- **Population.Y** - the estimated population of the destination country in 2018.

## Analysis

### Regression: Predicting Flights With GDP Growth

To address whether Per Capita GDP growth can be used to predict the number of flights from a particular country, a simple linear regression model was fit using parametric and nonparametric regression procedures. One condition for fitting such a model is Linearity between the variables of interest: average Per Capita GDP growth and counts. To investigate this relationship, scatterplots were generated with the linear regression fit and with the Loess smoother. The smoother fit a curved line, with a peak corresponding to a couple of large outliers. 

In an attempt to get a more linear relationship, the counts were then normalized by the population of the source country. We would expect countries with a larger population to have more flights than countries with a smaller population. Therefore, normalization should hopefully remove some unaccounted for variability. Normalization only resulted in minimal changes in the scatterplot and also results in a sharper curve in the loess smoother, particularly due to the pull of an extreme outlier: the Republic Nauru. 

We then considered possible transformations of the count variable. Plotting the natural log of counts against the average Per Capita growth suggested a weak to moderate, negative association between the two variables. The Loess smoother had a substantial upward curve, but when Nauru, the country previously identified as an outlier, was removed, this curve was removed. Unlike the previous plots, there appears to be less indication of any non-linear trends in the data, especially at higher values of average growth. Given that a condition of regression is Linearity, we chose to proceed with the normalized, natural log flight counts.

```{r, fig.width = 8, fig.height=3, echo=FALSE}
grid.raster(readPNG("report_fig1.png"))
```

A parametric linear regression model was then fit on `log_counts` as the response variable and `avg_growth.x` as the explanatory variable. The estimated slope coefficient for `avg_growth.x` was $-0.172$ with an associated t-value of $-2.659$ and a p-value of $0.00871$. Additionally, the multiple $R^{2}$ value for the model was $0.04588$. 

We have already addressed the Linearity condition, but there are some minor concerns for the remaining conditions, particularly the Normality condition. We observed some noticeable deviations from the reference line in the QQ plot, primarily at the upper end. Since we have concerns for Normality, we chose to fit a non-parametric simple linear regression model on the same variables.

For the non-parametric model, Normality is no longer a condition. Therefore, we have less concerns regarding whether or not all conditions are truly met. For this model, the estimated slope coefficient for `avg_growth.x` was $-0.178$ with an associated t-vale of $-2.756$ and a p-value of $0.00657$. Additionally, the multiple $R^{2}$ value for the model was $0.0485$.


### ANOVA: Investigating the  Significance of Development Status

> May only need one of the plots for this section? Both kind of show the same type of thing?

Before running ANOVA, we check boxplots:

```{r fig.width=4, fig.height=4,echo=FALSE}
grid.raster(readPNG("report_fig3.png"))
```

The boxplot and residual plot (not shown here) suggest that the spreads of developed and developing countries appear to be very similar, but the spread of recently developed countries is slightly smaller. Comparing standard deviations, recently developed countries have the largest, $1.817$, and developed countries have the smallest, $1.394$. Since the ratio of the largest standard deviation to the smallest is less than $2$ (approximately $1.303$), the Equal Variance condition appears to be roughly satisfied. The QQ plot shows some divergence from the reference line near both ends, as a result any p-values derived  from parametric ANOVA should be interpreted with caution.


> Report test stat, p-values. 

From the ANOVA by itself, we cannot determine which pairs have significantly different means. So we conducted Fisher's LSD to determine which pairs are significantly different.
> Report p-values

We next conduct a Krusall-Wallis rank sum test, which  provides an alternative to the one-way Parametric ANOVA. Similar to the ANOVA, it tests for differences in center. Unlike the ANOVA, however, which tests for differences in means, Kruskal-Wallis tests for difference in medians. The test gives us a Chi-squared test statistic of $52.653$ with two degrees of freedom, and therefore a resulting p-value of $3.686e-12$.

Since the Kruskal-Wallis test assumes a shift model, we consder the `log_count` density plot stratified by development status shown earlier. The distribution of developed appears to be potentially bimodal, but roughly symmetric. The two peaks are close together and of similar height. The distribution of developing is also bimodal, but the second peak is significant smaller than the first. Additionally, it appears roughly symmetric. Finally, the distribution of recently developed is also bimodal - if we ignore that third hump at the far right, which corresponds to the Republic of Nauru (identified as an outlier in analysis). The second peak is smaller and located on the left side of the distribution. Although there is some deviation in terms of shape, the distributions appear similar enough  to assume that the shift model assumption of the KW-test is met.

```{r, fig.width=8, fig.height=3,echo=FALSE}
grid.raster(readPNG("report_fig2.png"))
```

Although we've concluded that a difference is present, we cannot determine which pairs have significantly different medians Below, we conduct a Dunn test to determine which pairs are significantly different.

> Dunn test p-values.


### Proportion Tests: Exploring Whether Developing Fly to Popular Developed Destinations

```{r, fig.height = 4, fig.width = 8}
grid.raster(readPNG("report_fig4.png"))
```

After normalization, we  find that the top 5 destinations of developed nations  are: Antigua and Barbuda, Iceland, Saint Kitts and Nevis, Bermuda, and Austria. For developing nations, the  top 5 destinations are: Palau, the  Maldives, Nauru, Marshall Islands and Vanuatu. We use  proportion tests to compare the proportions of flights to the `top5` developed nation destinations to total nation status flight counts, between developing and developed nations. 




## Results - this is more like adiscussion section

### Regression: Predicting Flights With GDP Growth

For both the parametric and non-parametric model, we find that `avg_growth.x` is a significant predictor ($p<0.01$) of `log_counts`. According to the models, for ever single unit increase in the average Per Capita GDP growth, the `log_counts` is expected to decrease by approximately $0.17$, on average. However, the models only explains about $4.5$% of the variability in `log_count`. That is to say that GDP growth between 2010-2016 does not sufficiently explain why some countries have more originating flights than others. Therefore, although `avg_growth.x` is a significant predictor of `log_counts`, the model is not useful as a predictive model.


### ANOVA: Investigating the  Significance of Development Status


At all of the most commonly chosen significance levels, this is a significant p-value. We can reject the null hypothesis that there is no difference in the mean normalized `log_counts` between countries of different development status. We conclude that there is at least one difference in means between development status groups. 

> Fisher's LSD:

These results suggest that the mean normalized `log_counts` are significantly different between developed and developing countries (p-value $\approx 0$) as well as between developed and recently developed countries (p-value $= 0.01$), at a significance level of $0.05$. At any significant $\alpha$ level, however, we cannot reject the null hypothesis that there is no difference in means for developing and recently developed countries. 

> KW Conclusions

Therefore, we return to our p-value. At all of the most commonly chosen significance levels, this is a significant p-value. We can reject the null hypothesis that there is no difference in the median normalized `log_counts` between countries of different development status. We conclude that there is at least one difference in medians between development status groups. 

> Dunn conclusions

The results of the Dunn test suggest that the median normalized `log_counts` are significantly different between developed and developing countries (p-value $\approx 0$) as well as between developed and recently developed countries (p-value $ = 0.0091$ & $ = 0.0029$), at a significance level of $0.01$. At any significant $\alpha$ level, however, we cannot conclude that there is a difference in medians between developing and recently developed countries.

Our results indicate that recently developed countries do not differ from developing countries in terms of the normalized, natural log number of flights. Additionally, since recently developed countries differ from developed countries, we can conclude that travel has not increased in recently developed countries. In other words, recently developed countries are not distinguishable from developing countries in terms of the mean and median normalized, natural log counts of flights.


### Proportion Tests: Exploring Whether Developing Fly to Popular Developed Destinations


So our $p$ is the proporton of developed nation flights are to Antigua and Barbuda, Iceland, Saint Kitts and Nevis, Bermuda, and Austria, while developing nation flight proportions to the same  destinations are $p_0$. Thus, our hypotheses are: $H_0:p_0=p$, and $H_A:p_0\neq p$. 

Our question of interest here, therefore, is to test with statistical significance whether  developing nations fly to popular developed nation destinations as frequently as developed nations. A  stacked  bar plot shows some initial issues, namely that for three of the destinations being considered, Bermuda, Iceland, and St. Kitts and Nevis (KNA) there were no flights originating in  developing  nations whatsoever.

```{r echo=F, fig.height=3,fig.width=4, message=F,warning=F}
Outbound <- groupfdata %>% group_by(developed.x) %>% summarize(total_flights = n()) %>% data.frame()
total_developing <- subset(Outbound,developed.x==0)$total_flights
total_developed <- subset(Outbound,developed.x==1)$total_flights

groupfdata$spop <- str_replace(groupfdata$source.population,'\\.','')
pops <- groupfdata %>% 
  dplyr::select(country=Country.Code.x, pop=spop) %>% 
  unique() 

developedtop5 <- groupfdata %>% filter(Country.Code.x != Country.Code.y) %>%
  filter(developed.x == 1) %>%
  group_by(Country.Code.y) %>%
  summarize(count = n()) %>%
  left_join(pops, by=c("Country.Code.y"="country")) %>% 
  mutate(n_count = as.integer(count)/as.integer(pop)) %>% 
  arrange(desc(n_count)) %>% 
  head(5) %>% 
  data.frame()

developing_nn_ext <- groupfdata %>% filter(Country.Code.x != Country.Code.y) %>%
  filter(developed.x == 0) %>%
  group_by(Country.Code.y) %>%
  summarize(count = n()) %>%
  arrange(desc(count))

developing_n_ext <- developing_nn_ext %>% left_join(pops, by=c("Country.Code.y"="country")) %>% 
  mutate(n_count = as.integer(count)/as.integer(pop)) %>% 
  arrange(desc(n_count)) 

p_ATG <- developedtop5[[1,2]][1]
p_ISL <- developedtop5[[2,2]][1]
p_KNA <- developedtop5[[3,2]][1]
p_BMU <- developedtop5[[4,2]][1]
p_AUT <- developedtop5[[5,2]][1]

# Get Developing Country Counts for these countries:
p_ATG2 <- developing_n_ext[which(developing_n_ext$Country.Code.y=="ATG"),2] %>% unlist() %>% readr::parse_integer();  #  2
p_ISL2 <- 0 # developing_n_ext[which(developing_n_ext$Country.Code.y=="ISL"),2] %>% unlist() %>% readr::parse_integer()
p_KNA2 <- 0  # developing_n_ext[which(developing_n_ext$Country.Code.y=="KNA"),2] %>% unlist() %>% readr::parse_integer()
p_BMU2 <- 0  # developing_n_ext[which(developing_n_ext$Country.Code.y=="BMU"),2] %>% unlist() %>% readr::parse_integer()
p_AUT2 <- developing_n_ext[which(developing_n_ext$Country.Code.y=="AUT"),2] %>% unlist() %>% readr::parse_integer() #24

developedcounts <- c(p_ATG,p_AUT,p_BMU,p_ISL,p_KNA)
developingcounts <- c(2,24,0,0,0)

prop_developedcounts <- developedcounts/total_developed
prop_developingcounts <- developingcounts/total_developing

# data.frame(Countries=c("ATG","AUT","BMU","ISL","KNA"), Developed=prop_developedcounts, Developing=prop_developingcounts) %>%
#   melt() %>% rename(Type=variable) %>%
#   ggplot(aes(Countries,value,group=Type,fill=Type)) +
#   geom_bar(stat='identity',position='stack') +
#   labs(title="Stacked bar plot of proportional counts",y="Proportion")
```

The resulting  p-values of the   proportion  tests are as  follows:

```{r include=F}
prop.test(x = c(p_ATG, p_ATG2), n = c(total_developed, total_developing)) -> atg
prop.test(x = c(p_ISL, p_ISL2), n = c(total_developed, total_developing)) -> isl
prop.test(x = c(p_KNA, p_KNA2), n = c(total_developed, total_developing)) -> kna
prop.test(x = c(p_BMU, p_BMU2), n = c(total_developed, total_developing)) -> bmu;bmu
prop.test(x = c(p_AUT, p_AUT2), n = c(total_developed, total_developing)) -> aut

pvals <- c(atg$p.value,aut$p.value,bmu$p.value,isl$p.value,kna$p.value); pvals
data.frame(pvals=pvals,country=c("ATG","AUT","BMU","ISL","KNA")) #%>% xtable()
```



We find significant results for Austria (AUT) and Iceland (ISL), p-values of  $5.545961e-19$ and $7.775549e-05$, respectively. However, the  other tests are insignificant  at a 0.05 significance level. This is likely because conditions parametric proportion test conditions of at least 10 successes and 10 failures are not met for the other three countries. It is also questionable  whether we can consider are  trials independent. If we ignore  these questionable  conditions, we'd conclude that developing  countries fly  to Austria and  Iceland at different levels as developed countries.

```{r  include=F}
successes <- developingcounts # were testing developing proportions so we use these counts
failures <- total_developing-successes # calculating failures

# order: p_ATG,p_ISL,p_KNA,p_BMU,p_AUT

pvals2 <- rep(0,5)
for(i in 1:5){
  pvals2[i-1] <- (binom.test(c(successes[i],failures[i]),n=total_developing[i],p=prop_developedcounts[i]))$p.value
}
```

Because these conditions weren't met for the parametric proportion test, a non-parametric binomial test may prove more useful here. When we conduct  this we  find the following p-values:


Our  binomial test results differ from our proportion test results in that  they find that the Austria test is now insignificant (p=$0.2747$).  It also finds Iceland insignificant, but  not the other 3 countries. So  we might conclude that developing countries fly to Barbuda, Bermuda, and St. Kitts and Nevis in differentproportions as developed nations.

## Conclusion

## References

[1] Kaggle dataset, originally from openflights.org, available at: https://www.kaggle.com/open-flights/flight-route-database

[2] World  Bank GDP per capita, (PPP)  figures  in dollars: https://data.worldbank.org/indicator/NY.GDP.PCAP.PP.CD 

[3] World Bank definition of high-income economies defines it as $12,236 for the 2018 fiscal year: https://datahelpdesk.worldbank.org/knowledgebase/articles/906519#High_income
