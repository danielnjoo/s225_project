---
title: "Travel in Developed and Developing Countries"
author: "Jocelyn, Daniel"
date: "3/1/2018"
output:
  pdf_document:
    fig_height: 3
    fig_width: 7
  html_document: default
---

# Technical Appendix

```{r, include = FALSE}
library(tidyverse)
require(mosaic)
require(NSM3)
require(readr)
require(Rfit)
```

## Data Summary

### Data Read-In:
```{r, message = FALSE, warning = FALSE}
groupfdata <- read_csv("https://awagaman.people.amherst.edu/stat225/datasetsS2018/groupFdata.csv") 
groupfdata <- groupfdata %>% dplyr::select(-X1)

#data <- read.csv("Data/final_data.csv") %>% .[2:ncol(.)]
#data %>% dim()
```

The dataset includes 49 variables and 33,559 flights.

### Variables:
```{r}
# summary(groupfdata)
```

**Categorical Variables:**

- airline
- airline.ID
- source.airport
- source.airport.id 
- destination.apirport
- destination.airport.id
- codeshare ("Y" if codeshare, empty otherwise)
- stops ("0" for direct flight)
- equipment (3-letter codes for plane types generally used on the flight, seperated by spaces if more than one)
- source.airport.name
- source.country
- destination.airport.name
- destination.country
- Country.Code.x 
- developed.x (0 = developing; 1 = developed)
- Country.Code.y
- developed.y (0 = developing; 1 = developed)

**Quantitative Variables:**

- X2010.x:X2016.x (GDP each year from 2010 - 2016)
- growth10_11.x:growth15_16.x (GDP growth between two years from 2010 - 2016)
- avg_growth.x
- X2010.y:X2016.y (GDP each year from 2010 - 2016)
- growth10_11.y:growth15_16.y (GDP growth between two years from 2010 - 2016)
- avg_growth.y

**Please note** that a variable name with a '.x' corresponds to the source country of the flight and a variable name with a '.y' corresponds to the destination country of the flight. Additionally, `developed` is a categorical variable that indicates whether a country is developing or developed using the GDP cutoff of 10,490 dollars. This value is inflation adjusted from 12,000 today's dollars.

## Preliminary Univariate Analysis

### Countries

```{r}
groupfdata$source.country %>% unique() %>% length()
groupfdata$destination.country %>% unique() %>% length()
```

156 unique source and destination countries.

```{r}
length(which(groupfdata$developed.x==1))/nrow(groupfdata)
```

Of which 68% of the outbound countries are developed.

```{r}
length(which(groupfdata$developed.y==1))/nrow(groupfdata)
```

And 68% of the inbound countries are developed.

Numbers of flights for each source country over entire dataset:

```{r, fig.height=6, fig.width=7, echo = FALSE}
groupfdata %>% group_by(Country.Code.x, developed.x) %>% summarize(count=n()) -> temp 
temp %>% ggplot(aes(Country.Code.x,count, fill=as.factor(developed.x))) + 
  geom_bar(stat='identity') + 
  coord_flip() + 
  labs(title = "Number of Flights per Source Country", x = "Country", y = "Count")
```

The developing outlier is China:

```{r}
temp %>% arrange(count) %>% tail(1)
```

After normalizing the flight counts by population, China is no longer an outlier:

```{r, fig.height = 6, fig.width = 7, echo = FALSE}
groupfdata %>% group_by(Country.Code.x, developed.x, source.population) %>% 
  summarize(count=n()) -> temp

temp <- temp %>% mutate(count = count/source.population) %>% group_by(Country.Code.x,developed.x) %>% summarize(count = sum(count)) # Two very similar values of population for countries? 

temp %>% ggplot(aes(Country.Code.x,count, fill=as.factor(developed.x))) + 
  geom_bar(stat='identity') + 
  coord_flip() + 
  labs(title = "Normalized Number of Flights per Source Country", x = "Country", y = "Count")
```


### Source Country Per Capita GDP

```{r, echo = FALSE}
# Distribution of GDP:
data2 <- dplyr::select(groupfdata, '2010'=X2010.x, '2011'=X2011.x, '2012'=X2012.x, '2013'=X2013.x, '2014'=X2014.x, '2015'=X2015.x, '2016'=X2016.x, Country.Code.x, developed.x)
data2 <- gather(data2, key = "year", value = "GDP", -Country.Code.x, -developed.x)
```

```{r, echo = FALSE, warning = FALSE, message = FALSE}
# GDP Each Year:
ggplot(data2, aes(x = GDP, color = year)) + 
  geom_density() +
  ggtitle("Density plot of source countries' GDP by year")
```

We find that in the time period studied (2010-2016), composition of GDP of source countries is mainly consistent. This is likely because the composition of countries themselves is relatively consistent. The orange blip (year=2010) on the lower end of GDP is removed in 2011, which suggests a shift towards higher source country GDPs in later years.

```{r, echo = FALSE, warning = FALSE, message = FALSE}
# GDP by developed or developing:
ggplot(data2, aes(x = GDP, color = as.factor(developed.x))) + 
  geom_density() + 
  guides(color=guide_legend(title="Developed (1) or Developing (0)")) + 
  ggtitle('Density plot of source countries\' GDP, developed vs. developing') +
  theme(legend.position='bottom')
```

GDP is clearly differentiated by the development status of the source country. Developing countries have a narrower range of Per Capita GDP and the center of this distribution is located at the lower end of the overall Per Capita GDP range. Developed countries have a wider range of Per Capita GDP with a center located aboe the entire distribution of developing Per Capita GDP.

```{r, echo = FALSE}
# Distribution of GDP Growth:
data3 <- dplyr::select(groupfdata, growth10_11=growth10_11.x, growth11_12=growth11_12.x, growth12_13=growth12_13.x, growth13_14=growth13_14.x, growth14_15=growth14_15.x, growth15_16=growth15_16.x, Country.Code.x, developed.x)
data3 <- gather(data3, key = "year", value = "GDP_Growth", -Country.Code.x, -developed.x)
```

```{r, echo = FALSE, warning = FALSE, message = FALSE}
# GDP Growth Each Year:
ggplot(data3, aes(x = GDP_Growth, color = year)) + 
  geom_density() + 
  scale_x_continuous(limits=c(-20,20)) +
  ggtitle("Density plot of source country GDP growth")
```

The distributions of Per Capita GDP growth appear to be more variable between different pairs of years than the distribution of Per Capita GDP by year.

```{r}
# Distribution of Average GDP Growth:
ggplot(groupfdata, aes(x = avg_growth.x, color = as.factor(developed.x))) + 
  geom_density() +
  guides(color=guide_legend(title="Developed (1) or Developing (0)")) + 
  ggtitle("Density plot of source country average GDP growth by status") + 
  theme(legend.position='bottom')
```

The above is the distribution of the average Per Capita GDP Growth betwen 2010-2016 for developed and developing countries. Average growth for developing countries is shifted above the growth of developed countries. Additionally, the distribution is more symmetric for developed countries and left skewed for developing countries.

> For the above, may want to do some density estimation.


### Outbound Flights

```{r, echo = FALSE, message = FALSE, warning = FALSE}
groupfdata %>% group_by(source.country) %>% summarize(count=n()) -> temp
temp %>% ggplot(aes(count)) + 
  geom_histogram() + 
  xlab("number of outbound flights for a country") +
  ggtitle("Histogram of outbound flights/country")
```

```{r, echo = FALSE}
favstats(temp$count)
```

Huge SD (531.3929) and IQR (150.25)... identifying countries 2 SDs above the mean (i.e. 1278):

```{r, echo = FALSE}
# Identify Extreme Points:
groupfdata %>% group_by(source.country) %>% summarize(count = n()) %>% 
  filter(count > 1278) %>% arrange(desc(count))
```


### Inbound Flights

```{r, echo = FALSE, warning = FALSE, message = FALSE}
groupfdata %>% group_by(destination.country) %>% summarize(count=n()) -> temp
temp %>% ggplot(aes(count)) + 
  geom_histogram() + 
  xlab("number of inbound flights for a country") +
  ggtitle("Histogram of inbound flights/country")
```

```{r, echo = FALSE}
favstats(temp$count)
```

Similarly huge SD (530.3375, difference of 1.05 from outbound flights) and same IQR of 150.25... identifying countries 2 SDs above the mean (i.e. 1276):

```{r}
# Identify Extreme Points:
groupfdata %>% group_by(destination.country) %>% summarize(count = n()) %>% 
  filter(count > 1276) %>% arrange(desc(count)) 
```


### Developed vs. Developing Countries Outbound Flights

```{r, echo = FALSE, warning = FALSE, message = FALSE}
groupfdata %>% group_by(developed.x) %>% summarize(count=n()) %>% ggplot(aes(as.factor(developed.x),count)) + 
  geom_bar(stat='identity') + 
  xlab("developed (1) vs developing (0) countries") + 
  ggtitle("outbound flights for developing vs developed countries")
```

We can very clearly see that there are more outbound flights from developed than developing countries.


## Prediction of Total Number of Flights per Country by Average Growth

Investigating whether GDP growth leads to an increase in the number of flights in the consecutive year is worth investigating, but not available to us given the current dataset which does not inform us of the date of any given flight. Our data does allow us to see if we can predict the total number of flights per country by that countries average Per Capita GDP growth.

### Smoothing

To analyze the relationship between the Total Number of Flights per Country and Average Per Capita GDP, we begin by looking at a scatterplot to verify if the Linearity condition is met and whether or not transformations may be necessary.

```{r, warning = FALSE, echo = FALSE}
groupfdata %>% group_by(source.country, avg_growth.x) %>% summarize(count=n()) -> temp
temp %>% ggplot(aes(avg_growth.x, count)) + 
  geom_point() + 
  geom_smooth(method = 'lm', se=F) +
  ggtitle("SLR between source country avg GDP growth and # flights")
```

The plot above is a simple scatterplot of the average growth of the source country against the total count of flights for each source country. There does not appear to be any obvious trend in the data as the majority appear to be clustered together. There is one particularly extreme outlier at approximately 2900 flights. As discussed above, this outlier is China. The blue line represents the least squares fitted line. From this, we see that there is possibly a positive linear relationship between average growth and the number of flights. 

Using the `loess` smoother, another fitted line was generated from the same data as above:
```{r, warning = FALSE, echo = FALSE}
temp %>% ggplot(aes(avg_growth.x, count)) + 
  geom_point() + 
  geom_smooth(method = 'loess', se=F, color = "red") +
  ggtitle("SLR between source country avg GDP growth and # flights")
```

This new fitted line is curved with two small peaks around an average growth of 2.5 and another around 11. This is not a linear line. Additionally, the second peak is in alignment with China and one other outlier, which may suggest that the second peak is a result of the 'pull' of the outliers. To attempt to produce a more linear relationship, we first normalize by population.

```{r, warning = FALSE, echo = FALSE}
groupfdata %>% group_by(source.country, avg_growth.x, source.population, developed.x, X2016.x) %>% 
  summarize(count=n()) -> temp

normal <- temp %>% mutate(count = count/source.population) %>% group_by(source.country, avg_growth.x, developed.x, X2016.x) %>% summarize(count = sum(count))

normal %>% ggplot(aes(avg_growth.x, count)) + 
  geom_point() + 
  geom_smooth(method = 'lm', se=F) +
  ggtitle("SLR between source country avg GDP growth and Normalized # flights")
```

Despite normalizing, there are still outliers present.

```{r, warning = FALSE, echo = FALSE}
normal %>% ggplot(aes(avg_growth.x, count)) + 
  geom_point() + 
  geom_smooth(method = 'loess', se=F, col = "red") +
  ggtitle("SLR between source country avg GDP growth and Normalized # flights")
```

The Loess smoother suggests a curved relationship between the data, rather than a strictly linear one. It appears that the trend may be exponential or close to an exponential curve. Keeping the normalized data, we can compare average growth to the natural log of the counts.

```{r, warning = FALSE, echo = FALSE}
normal <- normal %>% mutate(log_count = log(count))

normal %>% ggplot(aes(avg_growth.x, log_count)) + 
  geom_point() + 
  geom_smooth(method = 'lm', se=F) +
  labs(title = "Normalized Log Number of Flights Per Source Country vs. Avg GDP Growth", x = "Average Growth", y = "Natural Log Counts")
```

While the relationship between average growth and the natural log of counts does not appear to be a strong one, it is more linear. The linear regression line fit through the above scatterplot suggests a weak to moderate, negative association between average growth and the natural log of counts.

```{r, warning = FALSE, wcho = FALSE}
normal %>% ggplot(aes(avg_growth.x, log_count)) + 
  geom_point() + 
  geom_smooth(method = 'loess', se=F, color = "red") +
  labs(title = "Normalized Log Number of Flights Per Source Country vs. Avg GDP Growth", x = "Average Growth", y = "Natural Log Counts")
```

The Loess smoother still suggests a more curved relationship between the two variables. There is only one data point above an average growth of 10 that appears to be influencing the smoother. We remove this point below:

```{r, warning = FALSE, echo = FALSE}
normal_minus <- normal %>% filter(avg_growth.x < 12)
outliers <- normal %>% filter(avg_growth.x > 12)

normal_minus %>% ggplot(aes(avg_growth.x, log_count)) + 
  geom_point() + 
  geom_smooth(method = 'loess', se=F, color = "red") +
  labs(title = "Normalized Log Number of Flights Per Source Country vs. Avg GDP Growth", x = "Average Growth", y = "Natural Log Counts")

```

The outlier was Nauru, a small, developing country. Without Nauru, the Loess smoother fits a line that is still slightly curved, but is definitely more linear than previously.
> Outlier: Nauru - developing country - include or not? or try both?

For this analysis, parametric and non-parametric regression procedures will be carried out on average GDP growth and the normalized, natural log of the number of flights per source country.


### Parametric Regression

A parametric, simple linear regression model was then with the normalized `log_counts` as the response variable and `avg_growth.x` as the predictor variable. The summary output for the parametric model is below:

> Exclusion of outlier leads to minor improvement of conditions, increase in R-squared, and smaller p-value. Fit with or without outlier?

```{r}
p_mod <-  lm(log_count ~ avg_growth.x, data = normal)
summary(p_mod)
```

The t-value for the slope coefficient of `avg_growth.x` is $-0.109$ with an associated p-value of $0.0211$. At $\alpha = 0.05$, this is a significant p-value. Before drawing any further conclusions, the conditions must be met. We've already verified that Linearity condition is satisfied and it seems safe to assume that Independence also holds. We verify below that the Equal Variance and Normality conditions are also met:

```{r, echo = FALSE}
# Conditions:
plot(p_mod, which = 1)
plot(p_mod, which = 2)

```

For the most part, the Equal Variance condition appears to be met. The residuals appear to be randomly clustered, evenly spread, and centered around 0. There is one point to take note of: 179, which corresponds to the outlier identified earlier (Nauru). Looking at the QQ plot, there is very little deviation from the reference line. Therefore, the Normality condition is also met. 

Since the p-value is small, at $\alpha = 0.05$, we reject the null hypothesis and conclude that the slope coefficient for `avg_growth.x` is significantly different from 0. In other words, the model suggests that `avg_growth.x` is a significant predictor of the normalized `log_counts` of flights. The coefficient of $-0.109$ indicates that for every 1 unit increase in the `avg_growth.x`, the noramlized `log_counts` is estimated to decrease by approximately $-0.109$. While `avg_growth.x` is a significant predicotr, the model itself has low predictive power. The model only accounts for $1.89%$ of the variability in `log_counts` (Multiple $R^{2} = 0.0189$).


### Non-parametric Regression

> Insert Commentary:

```{r}
np_mod <- rfit(log_count ~ avg_growth.x, data = normal_minus)
summary(np_mod, overall = 'drop')
```

> Report t value and p-value.
> Don't need to check Normality - just Equal Variance

```{r, echo = FALSE}
plot(np_mod$residuals ~ np_mod$fitted.values)
```

> Same outlier seen in parametric.

> Conclusions

> Comparison - can't really use to predict despite being significant because of low R-squared value.


## Has Travel Increased in Recently Developed Countries?

Given that there is no `year` associated with each flight, we can determine if the average number of flights (normalized by population size for each country) is significantly greater for recently developed countries versus developing countries. An additional comparison can be made between recently developed countries and established, developed countries.

```{r, echo = FALSE}
groupfdata %>% group_by(source.country, X2010.x, X2016.x, developed.x) %>% summarize() -> temp
temp %>% mutate(developed.x2 = ifelse(X2016.x>12000,1,0)) -> temp
temp[which(temp$developed.x2-temp$developed.x==1),]
```

We find that 7 of the 156 countries in the dataset were undeveloped in 2010 (\$10490.48), and developed in 2016 (\$12000). 

> Add Commentary - proceed with or without outlier? Changes the shape of the smoother

```{r, warning = FALSE, echo = FALSE}
check <- normal %>% mutate(developed.x2 = ifelse(X2016.x > 12000, 1, 0)) %>% 
  mutate(recent_development.x = ifelse(developed.x == 0 & developed.x2 == 0, "Developing", ifelse(developed.x == 0 & developed.x2 == 1, "Recently Developed", "Developed"))) %>% filter(!is.na(recent_development.x))

check2 <- check %>% filter(avg_growth.x < 12)

check %>% ggplot(aes(avg_growth.x, log_count, color = recent_development.x)) + 
  geom_point() + 
  geom_smooth(method = 'lm', se=F) +
  ggtitle("SLR between source country avg GDP growth and Normalized # flights")

```

> Insert Commentary:

```{r, warning = FALSE}
check %>% ggplot(aes(avg_growth.x, log_count, color = recent_development.x)) + 
  geom_point() + 
  geom_smooth(method = 'loess', se=F) +
  ggtitle("SLR between source country avg GDP growth and Normalized # flights")
```

> Anova?
> Or just fit parallel slopes model?
> OR BOTH?

```{r}
# With outlier:
p_mod2 <- lm(log_count ~ recent_development.x, data = check)
anova(p_mod2) 
# Without:
p_mod3 <- lm(log_count ~ recent_development.x, data = check2)
anova(p_mod3)
```

> Commentary - Verify conditions.

```{r}
favstats(log_count ~ recent_development.x, data = check) # Fine
check %>% ggplot(aes(recent_development.x, log_count)) + geom_boxplot()
```

> Concern for Normality - do NP, Equal Variance Looks good. 

```{r}
# Fisher's LSD:
with(check, pairwise.t.test(log_count, recent_development.x))
```

> Commentary on Parametric MC

> Commentary for NP ANOVA:

```{r}
kruskal.test(log_count~as.factor(recent_development.x), data=check)
```

> Verify Shift Model - Roughly appropriate:

```{r}
check %>% ggplot(aes(log_count, color = recent_development.x)) + geom_density()
```

> Comments on Plot

> Report results of NP ANOVA - MC

```{r}
with(check, pairwise.wilcox.test(log_count, recent_development.x))
```

> Report, Conclude, and Compare


### Travel Locations

First, we can look at travel outside of one's own country (source does not equal destination):

```{r}
# Developed
hold <- groupfdata %>% filter(destination.country != source.country) %>%
  filter(developed.x == 1) %>%
  group_by(destination.country) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  head(5); hold
# Developing
hold2 <- groupfdata %>% filter(destination.country != source.country) %>%
  filter(developed.x == 0) %>%
  group_by(destination.country) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  head(5); hold2
```


Without normalization, we find that the top 5 overseas destinations of developed countries are the UK, Germany, Spain, Italy, and France.

Whereas for developing countries, these destinations are the UAE, Singapore, Japan, France, and China.

If we include travel within one's own country (souce can equal destination), the results are the same for the developed countries, but differ slightly for the developing ones:

```{r}
hold4 <- groupfdata %>% filter(developed.x == 0) %>%
  group_by(destination.country) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  head(5); hold4
```

Now the top five destinations for developing countries are China, India, Indonesia, UAE, and Singapore.

In our analysis we'll conduct a z-test for proportions.

