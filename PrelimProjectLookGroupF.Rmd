---
title: "Prelim Project Look - GroupF"
author: "Jocelyn, Daniel"
date: "3/1/2018"
output:
  pdf_document:
    fig_height: 3
    fig_width: 7
---

# Project Title: Travel in Developed and Developing Countries

```{r, include = FALSE}
library(tidyverse)
require(mosaic)
require(NSM3)
require(readr)
require(Rfit)
```

## Data Summary

### Data Read-In:
```{r}
data <- read.csv("Data/final_data.csv") %>% .[2:ncol(.)]
data %>% dim()
```

The dataset includes 45 variables and 33,559 flights.

### Summary Command:
```{r}
summary(data)
```

## Data Codebook

### Categorical Variables:
- airline
- airline.ID
- source.airport
- source.airport.id 
- destination.apirport
- destination.airport.id
- codeshare ("Y" if codeshare, empty otherwise)
- stops ("0" for direct flight)
- equipment (3-letter codes for plane types generally used on the flight, seperated by spaces if more than one)
- source.airport.name
- source.country
- destination.airport.name
- destination.country
- Country.Code.x 
- developed.x (0 = developing; 1 = developed)
- Country.Code.y
- developed.y (0 = developing; 1 = developed)

### Quantitative Variables:
- X2010.x:X2016.x (GDP each year from 2010 - 2016)
- growth10_11.x:growth15_16.x (GDP growth between two years from 2010 - 2016)
- avg_growth.x
- X2010.y:X2016.y (GDP each year from 2010 - 2016)
- growth10_11.y:growth15_16.y (GDP growth between two years from 2010 - 2016)
- avg_growth.y

**Please note** that a variable name with a '.x' corresponds to the source country of the flight and a variable name with a '.y' correpsonds to the destination country of the flight. Additionally, `developed` is a categorical variable that indicates whether a country is developing or developed using the GDP cutoff of 10,490 dollars. This value is inflation adjusted from $12,000 today's dollars.

## Analysis Plan

### Selected Univariate Analysis

#### Countries

```{r}
data$source.country %>% unique() %>% length()
data$destination.country %>% unique() %>% length()
```

156 unique source and destination countries.

```{r}
length(which(data$developed.x==1))/nrow(data)
```

Of which 68% of the outbound countries are developed.

```{r}
length(which(data$developed.y==1))/nrow(data)
```

And 68% of the inbound countries are developed.

Numbers of flights for each source country over entire dataset:

```{r, fig.height=6, fig.width=7}
data %>% group_by(Country.Code.x, developed.x) %>% summarize(count=n()) -> temp 
temp %>% ggplot(aes(Country.Code.x,count, fill=as.factor(developed.x))) + 
  geom_bar(stat='identity') + 
  coord_flip() + 
  labs(title = "Number of Flights per Source Country", x = "Country", y = "Count")
```

The developing outlier is China:

```{r}
temp %>% arrange(count) %>% tail(1)
```

If we normalized flights for population, this would be less of an outlier.

### GDP (source countries)

```{r}
# Distribution of GDP:
data2 <- dplyr::select(data, '2010'=X2010.x, '2011'=X2011.x, '2012'=X2012.x, '2013'=X2013.x, '2014'=X2014.x, '2015'=X2015.x, '2016'=X2016.x, Country.Code.x, developed.x)
data2 <- gather(data2, key = "year", value = "GDP", -Country.Code.x, -developed.x)
```

```{r}
# GDP Each Year:
ggplot(data2, aes(x = GDP, color = year)) + 
  geom_density() +
  ggtitle("Density plot of source countries' GDP by year")
```

We find that in the time period studied (2010-2016), composition of GDP of source countries is mainly consistent. This is likely because the composition of countries themselves is relatively consistent. The orange blip (year=2010) on the lower end of GDP is removed in 2011, which suggests a shift towards higher source country GDPs in later years.

```{r}
# GDP by developed or developing:
ggplot(data2, aes(x = GDP, color = as.factor(developed.x))) + 
  geom_density() + 
  guides(color=guide_legend(title="Developed (1) or Developing (0)")) + 
  ggtitle('Density plot of source countries\' GDP, developed vs. developing') +
  theme(legend.position='bottom')
```

GDP is clearly differentiated by developing/developed status of the source country. This is as expected.

```{r}
# Distribution of GDP Growth:
data3 <- dplyr::select(data, growth10_11=growth10_11.x, growth11_12=growth11_12.x, growth12_13=growth12_13.x, growth13_14=growth13_14.x, growth14_15=growth14_15.x, growth15_16=growth15_16.x, Country.Code.x, developed.x)
data3 <- gather(data3, key = "year", value = "GDP_Growth", -Country.Code.x, -developed.x)
```

```{r}
# GDP Growth Each Year:
ggplot(data3, aes(x = GDP_Growth, color = year)) + 
  geom_density() + 
  scale_x_continuous(limits=c(-20,20)) +
  ggtitle("Density plot of source country GDP growth")
```

```{r}
# GDP Growth by developed or developing:
ggplot(data3, aes(x = GDP_Growth, color = as.factor(developed.x))) + 
  geom_density() + 
  scale_x_continuous(limits=c(-20,20)) +
  guides(color=guide_legend(title="Developed (1) or Developing (0)")) + 
  ggtitle("Density plot of source country GDP growth by status") + 
  theme(legend.position='bottom')
```

```{r}
# Distribution of Average GDP Growth:
ggplot(data, aes(x = avg_growth.x, color = as.factor(developed.x))) + 
  geom_density() +
  guides(color=guide_legend(title="Developed (1) or Developing (0)")) + 
  ggtitle("Density plot of source country average GDP growth by status") + 
  theme(legend.position='bottom')
```


#### Outbound Flights

```{r}
data %>% group_by(source.country) %>% summarize(count=n()) -> temp
temp %>% ggplot(aes(count)) + 
  geom_histogram() + 
  xlab("number of outbound flights for a country") +
  ggtitle("Histogram of outbound flights/country")
```

```{r}
favstats(temp$count)
```

Huge SD (531.3929) and IQR (150.25)... identifying countries 2 SDs above the mean (i.e. 1278):

```{r}
# Identify Extreme Points:
data %>% group_by(source.country) %>% summarize(count = n()) %>% 
  filter(count > 1278) %>% arrange(desc(count))
```

#### Inbound Flights

```{r}
data %>% group_by(destination.country) %>% summarize(count=n()) -> temp
temp %>% ggplot(aes(count)) + 
  geom_histogram() + 
  xlab("number of inbound flights for a country") +
  ggtitle("Histogram of inbound flights/country")
```

```{r}
favstats(temp$count)
```

Similarly huge SD (530.3375, difference of 1.05 from outbound flights) and same IQR of 150.25... identifying countries 2 SDs above the mean (i.e. 1276):

```{r}
# Identify Extreme Points:
data %>% group_by(destination.country) %>% summarize(count = n()) %>% 
  filter(count > 1276) %>% arrange(desc(count)) 
```


#### Developed vs Developing Countries Outbound Flights

```{r}
data %>% group_by(developed.x) %>% summarize(count=n()) %>% ggplot(aes(as.factor(developed.x),count)) + 
  geom_bar(stat='identity') + 
  xlab("developed (1) vs developing (0) countries") + 
  ggtitle("outbound flights for developing vs developed countries")
```

We can very clearly see that there are more outbound flights from developed than developing countries.

### SLR - Average Growth to Predict Total Number of Flights per Country:

#### Parametric Regression:

```{r}
data %>% group_by(source.country, avg_growth.x) %>% summarize(count=n()) -> temp
temp %>% ggplot(aes(avg_growth.x, count)) + 
  geom_point() + 
  geom_smooth(method = 'lm', se=F) +
  ggtitle("SLR between source country avg GDP growth and # flights")
```

Positive linear relationship suggests more GDP growth is associated with more flights. There appears to be one major outlier. **Note** that this is a count of flights across the entire dataset, and does not therefore suggest a direct increase in the number of flights for countries with high GDP growth.

Investigating whether GDP growth leads to an increase in the number of  flights in the consecutive year is worth investigating, but not available to us given the current dataset which does not inform us  of the date  of any given flight.

```{r}
mod <-  lm(count ~ avg_growth.x, data = temp)
summary(mod)
```

```{r}
# Conditions:
plot(mod, which = 1)
plot(mod, which = 2)
```
The p-value of $0.4419$ is not significant at any appropriate $\alpha$ level. Average GDP growth does not appear to be a significant predictor of the total count of flights.

Conditions do not appear to be met for parametric linear regression. The points do not appear to be equally distributed above and below zero. Additionally, they appear to following a negative trend (as indicated by the red line). Normality is also violated. The observed residuals diverge from the reference line heavily at the upper end. 

Normalizing the counts by population may fix this problem.

#### Non-parametric Regression:

```{r}
np_mod <- rfit(count ~ avg_growth.x, data = temp)
summary(np_mod, overall = 'drop')
```

Currently both overall models tests give insignificant results, but the parametric model is closer to significant. 

### Travel Increased in Recently Developed Countries?

Given that there is no `year` associated with each flight, we can determine if the average number of flights (normalized by population size for each country) is significantly greater for recently developed countries versus developing countries. An additional comparison can be made between recently developed countries and established, developed countries.

```{r}
data %>% group_by(source.country, X2010.x, X2016.x, developed.x) %>% summarize() -> temp
temp %>% mutate(developed.x2 = ifelse(X2016.x>12000,1,0)) -> temp
temp[which(temp$developed.x2-temp$developed.x==1),]
```

We find that 7 of the 156 countries in the dataset were undeveloped in 2010 (\$10490.48), and developed in 2016 (\$12000). 

### Travel Locations

First, we can look at travel outside of one's own country (source does not equal destination):

```{r}
# Developed
hold <- data %>% filter(destination.country != source.country) %>%
  filter(developed.x == 1) %>%
  group_by(destination.country) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  head(5); hold
# Developing
hold2 <- data %>% filter(destination.country != source.country) %>%
  filter(developed.x == 0) %>%
  group_by(destination.country) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  head(5); hold2
```


Without normalization, we find that the top 5 overseas destinations of developed countries are the UK, Germany, Spain, Italy, and France.

Whereas for developing countries, these destinations are the UAE, Singapore, Japan, France, and China.

If we include travel within one's own country (souce can equal destination), the results are the same for the developed countries, but differ slightly for the developing ones:

```{r}
hold4 <- data %>% filter(developed.x == 0) %>%
  group_by(destination.country) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  head(5); hold4
```

Now the top five destinations for developing countries are China, India, Indonesia, UAE, and Singapore.

In our analysis we'll conduct a z-test for proportions.

